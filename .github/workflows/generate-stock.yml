name: Generate Stock Report

on:
  workflow_dispatch:
    inputs:
      ticker:
        description: 'Ticker symbol (e.g. RKLB)'
        required: false
        type: string
      name:
        description: 'Company name (e.g. Rocket Lab)'
        required: false
        type: string
      strict:
        description: 'Fail when critical source fields are missing'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      allow_placeholders:
        description: 'Allow placeholder text for missing narrative fields'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      create_pr:
        description: 'Create a pull request with generated files'
        required: true
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

permissions:
  contents: write
  pull-requests: write

jobs:
  generate:
    runs-on: ubuntu-latest
    env:
      SEC_USER_AGENT: investor-report-generator/1.0 (github-actions@users.noreply.github.com)

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate input
        run: |
          set -euo pipefail
          ticker="${{ inputs.ticker }}"
          name="${{ inputs.name }}"
          if [ -z "$ticker" ] && [ -z "$name" ]; then
            echo "Either ticker or name must be provided."
            exit 1
          fi

      - name: Generate stock JSON
        run: |
          set -euo pipefail
          args=()
          ticker="${{ inputs.ticker }}"
          name="${{ inputs.name }}"
          strict="${{ inputs.strict }}"
          allow_placeholders="${{ inputs.allow_placeholders }}"

          if [ -n "$ticker" ]; then
            args+=(--ticker "$ticker")
          fi
          if [ -n "$name" ]; then
            args+=(--name "$name")
          fi

          if [ "$strict" = "false" ]; then
            args+=(--no-strict)
          else
            args+=(--strict)
          fi

          if [ "$allow_placeholders" = "false" ]; then
            args+=(--no-allow-placeholders)
          else
            args+=(--allow-placeholders)
          fi

          args+=(--build-index --force)
          npm run generate:stock -- "${args[@]}"

      - name: Upload generated artifacts
        uses: actions/upload-artifact@v4
        with:
          name: generated-stock-data
          path: |
            data/*.json
            data/sources/*.json

      - name: Create Pull Request
        if: ${{ inputs.create_pr == 'true' }}
        uses: peter-evans/create-pull-request@v6
        with:
          branch: chore/auto-stock-generation
          commit-message: 'chore: auto-generate stock report'
          title: 'chore: auto-generated stock report data'
          body: |
            This PR was generated by the `Generate Stock Report` workflow.

            Inputs:
            - ticker: `${{ inputs.ticker }}`
            - name: `${{ inputs.name }}`
            - strict: `${{ inputs.strict }}`
            - allow_placeholders: `${{ inputs.allow_placeholders }}`
